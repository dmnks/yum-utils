# pkgtorrent
pkgtorrent is a plugin for yum and solves scalability issues when a large
number of systems try to download rpm packages in bursts. This circumstance is
commonly encountered when using configuration management, e.g. Chef.

The name is pkgtorrent because the service is not specific to RPM or yum.

## Examples

* Based on usage data, approximately 40% of blocks for package downloads are
  peer-to-peer.
* Has been in continuous use at Facebook since July 2014.

## Requirements

### Client

* Linux OS (due to /proc lookups)
* CLI based bittorrent client, e.g. http://50hz.ws/hrktorrent/ with the
  following features:
 * Accepts a single positional torrent filename parameter
 * Downloads to the current working directory
 * Supports http://bittorrent.org/beps/bep_0019.html (everything using
   libtorrent should)

### Server

* WSGI capable http server with direct file access to yum repositories "origin"
* Optional: http caching service between origin and clients
* BitTorrent Tracker, e.g. https://github.com/chihaya/chihaya

## Building pkgtorrent

Part of yum-utils

## Installing pkgtorrent

* yum install yum-plugin-pkgtorrent on clients
* yum install pkgtorrentservice on yum mirror

## Developing pkgtorrent

You can set up a simple development environment with Docker Compose.

First, you need to download and build the Chihaya Tracker image:
```bash
$ git clone https://github.com/chihaya/chihaya /path/to/repo
$ docker build -t chihaya /path/to/repo
```

Second, you need to create a dummy repo in `/tmp/pkgtorrent_repo` on your host
to be served by the server container:
```bash
$ mkdir /tmp/pkgtorrent_repo
$ cp /path/to/pkg1 ... /tmp/pkgtorrent_repo
$ createrepo /tmp/pkgtorrent_repo
```

Now you are ready to spin up the environment:
```bash
$ docker-compose up -d
```

That will run 3 containers in detached mode: the server, tracker and client.
Both the server and client containers are running bash by default so you can
attach to them with `docker attach` and run httpd and yum interactively.  They
also have the WSGI and plugin scripts mounted from the host.

For example, you can first insert a breakpoint somewhere:

```python
import pdb; pdb.set_trace()
```

Then you can attach to the server container and run httpd in debug mode:

```bash
$ docker attach pkgtorrent_server_1
[root@server ~]$ httpd -X
```

Finally, you can attach to the client container (perhaps from another terminal)
and run yum to install a package from the server repo (other repos are
disabled):

```bash
$ docker attach pkgtorrent_client_1
[root@client ~]$ yum install -y pkg1
```

Once the breakpoint is hit, the pdb shell will be launched inside the container
and you can proceed as usual.  Note that if you prefer the fullscreen pudb over
pdb, it is included in the server and client images as well.

You can run as many client containers as you wish by using `docker-compose
scale`.  For example, to spin up another client (e.g. to test peer-to-peer
downloading), run:

```bash
$ docker-compose scale client=2
$ docker attach pkgtorrent_client_2
```

## How pkgtorrent works

The client calculates which packages it wishes to download, then, in a
pre-download hook, a digest of the packages is requested from the yum mirror.
If the yum mirror has seen this specific permutation before, it will
return a .torrent file and will download the files, then link them into the
local yum cache. If the permutation was not known, a POST with enough data
to build the .torrent is sent instead. In case of error, the plugin will not
download the files, so the regular download behaviour will fulfil the request.

The client will continue to seed the file for a period after the download
completes. There is no direct orchestration between clients.

If more than one file is requested, the .torrent is built with each file padded
by another "nullfile" up to the next blocksize. The nullfiles are procedurally
generated by the web server and once downloaded, are made sparse by the client.
This padding enables reuse of SHA1 block lists between different permutations
of files being downloaded. This design trades some network I/O on the part
of the client for efficiency and speed in generating the .torrent files.

## Full documentation

See the man pages:

* yum-torrent(1)
* yum-torrent.conf(5)
* pkgtorrent-service(8)
* pkgtorrent-service.conf(5)

## License
pkgtorrent is GPLv2-licensed.
